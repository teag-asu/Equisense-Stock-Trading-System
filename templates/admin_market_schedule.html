<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EquiSense - Market Schedule</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .flash-message {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-weight: bold;
    }
    .flash-success {
      background: #e8f5e9;
      color: #256029;
    }
    .flash-error {
      background: #ffebee;
      color: #b71c1c;
    }
  </style>
</head>

<body>
  <main>
    <section class="panel">
      <h2>Market Schedule</h2>
      <p>Set the market calendar and trading days.</p>

      <div id="flash" style="display:none;"></div>

      <form id="scheduleForm">

        <!-- Trading days -->
        <div>
          <label>Trading Days:</label>

          <div>
            <input type="checkbox" id="monday" value="monday">
            <label for="monday">Monday</label>
          </div>

          <div>
            <input type="checkbox" id="tuesday" value="tuesday">
            <label for="tuesday">Tuesday</label>
          </div>

          <div>
            <input type="checkbox" id="wednesday" value="wednesday">
            <label for="wednesday">Wednesday</label>
          </div>

          <div>
            <input type="checkbox" id="thursday" value="thursday">
            <label for="thursday">Thursday</label>
          </div>

          <div>
            <input type="checkbox" id="friday" value="friday">
            <label for="friday">Friday</label>
          </div>
        </div>

        <!-- Holidays -->
        <div>
          <label for="holidays">Market Holidays (one per line):</label>
          <textarea id="holidays" rows="5"
            placeholder="01-01 - New Year's Day&#10;07-04 - Independence Day&#10;12-25 - Christmas Day"></textarea>
        </div>

        <button type="submit">Save Schedule</button>
      </form>
    </section>
  </main>

  <script>
    const flashBox = document.getElementById("flash");
    function showFlash(msg, ok = true) {
      flashBox.style.display = "block";
      flashBox.textContent = msg;
      flashBox.className = ok
        ? "flash-message flash-success"
        : "flash-message flash-error";
      setTimeout(() => (flashBox.style.display = "none"), 3000);
    }

    // load existing schedule from backend
    async function loadSchedule() {
      try {
        const res = await fetch("/api/admin/market/schedule");
        const data = await res.json();

        if (!data) return;

        // trading_days stored in manual_status as JSON (repurposed field)
        if (data.manual_status) {
          try {
            const schedule = JSON.parse(data.manual_status);
            if (schedule.trading_days) {
              schedule.trading_days.forEach((day) => {
                const cb = document.getElementById(day);
                if (cb) cb.checked = true;
              });
            }
            if (schedule.holidays) {
              document.getElementById("holidays").value =
                schedule.holidays.join("\n");
            }
          } catch (e) {
            console.warn("No valid schedule stored");
          }
        }
      } catch (error) {
        showFlash("Error loading schedule.", false);
      }
    }

    document.getElementById("scheduleForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      // collect trading days
      const days = [];
      ["monday", "tuesday", "wednesday", "thursday", "friday"].forEach((d) => {
        if (document.getElementById(d).checked) days.push(d);
      });

      // collect holidays
      const holidaysText = document.getElementById("holidays").value.trim();
      const holidays = holidaysText
        ? holidaysText.split("\n").map((h) => h.trim())
        : [];

      // Store full schedule JSON inside manual_status
      const schedulePayload = {
        trading_days: days,
        holidays: holidays
      };

      try {
        const res = await fetch("/api/admin/market/schedule", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            is_open_today: 1,
            manual_override: 1,              // enables storing custom schedule
            manual_status: JSON.stringify(schedulePayload)
          })
        });

        const data = await res.json();
        if (data.success) {
          showFlash("Market schedule saved successfully!");
        } else {
          showFlash("Failed to save schedule.", false);
        }
      } catch (err) {
        showFlash("Network error.", false);
      }
    });

    loadSchedule();
  </script>
</body>
</html>
