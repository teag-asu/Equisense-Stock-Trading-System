<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EquiSense - Trading Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
<header>
  <h1>EquiSense</h1>
  <nav>
    <ul>
      <li><a href="{{ url_for('dashboard', user_id=user_id) }}">Trading Dashboard</a></li>
      {% if session.is_admin == 1 %}
      <li><a href="{{ url_for('admin') }}">Admin Panel</a></li>
      {% endif %}
    </ul>
  </nav>
  <div class="user-info">
    <p>Logged in as: <strong>{{ user['username'] }}</strong></p>
    <form action="{{ url_for('logout') }}" method="post">
      <button type="submit">Log Out</button>
    </form>
  </div>
</header>

<main>

  <!-- Market status banner -->
  <div id="market-status-banner"
       style="display:none; padding:12px; margin:12px; border-radius:8px; background:#ffeeee;">
    <strong id="market-status-text"></strong>
    <div id="market-reason" style="margin-top:6px;"></div>
    <div id="market-nextopen" style="margin-top:6px; font-style:italic;"></div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Account Summary -->
  <section class="panel">
    <h2>Account Summary</h2>
    <div class="account-summary">
      <div class="balance-item">
        <h3>Cash Balance</h3>
        <p>${{ "%.2f"|format(balance) }}</p>
      </div>
      <div class="balance-item">
        <h3>Portfolio Value</h3>
        <p>${{ "%.2f"|format(portfolio|sum(attribute='value') or 0) }}</p>
      </div>
      <div class="balance-item">
        <h3>Total Account Value</h3>
        <p>${{ "%.2f"|format(balance + (portfolio|sum(attribute='value') or 0)) }}</p>
      </div>
    </div>
  </section>

  <!-- Account Actions -->
  <section class="panel">
    <h2>Account Actions</h2>
    <div class="form-section">
      <div class="depositwithdraw">
        <h3>Deposit / Withdraw</h3>
        <form action="{{ url_for('depositwithdraw', user_id=user_id) }}" method="post">
          <label for="account-amount">Amount</label>
          <input type="number" id="account-amount" name="amount" step="0.01" required>
          <div class="button-row">
            <button type="submit" name="action" value="deposit">Deposit</button>
            <button type="submit" name="action" value="withdraw">Withdraw</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- Available Stocks -->
  <section class="panel">
    <h2>Available Stocks</h2>
    {% if available_stocks %}
      <table>
        <tr>
          <th>Symbol</th>
          <th>Company</th>
          <th>Current Price</th>
          <th>Action</th>
        </tr>
        {% for stock in available_stocks %}
          <tr>
            <td>{{ stock.symbol }}</td>
            <td>{{ stock.company_name }}</td>
            <td>${{ "%.2f"|format(stock.price) }}</td>
            <td>
              <form action="{{ url_for('buy_stock', user_id=user_id) }}" method="post" style="display:inline;">
                <input type="hidden" name="stock_id" value="{{ stock.stock_id }}">
                <input type="number" name="quantity" placeholder="Qty" min="1" required style="width:60px;">
                <button type="submit">Buy</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No stocks available. Admin needs to add stocks to the system.</p>
    {% endif %}
  </section>

  <!-- My Holdings -->
  <section class="panel">
    <h2>My Holdings</h2>
    {% if portfolio %}
      <table>
        <tr>
          <th>Symbol</th>
          <th>Company</th>
          <th>Shares</th>
          <th>Avg Cost</th>
          <th>Current Price</th>
          <th>Market Value</th>
          <th>P/L</th>
          <th>Action</th>
        </tr>
        {% for holding in portfolio %}
          <tr>
            <td>{{ holding.symbol }}</td>
            <td>{{ holding.company_name }}</td>
            <td>{{ holding.quantity }}</td>
            <td>${{ "%.2f"|format(holding.avg_cost or 0) }}</td>
            <td>${{ "%.2f"|format(holding.current_price) }}</td>
            <td>${{ "%.2f"|format(holding.value) }}</td>
            <td class="{% if holding.unrealized_pl >= 0 %}positive{% else %}negative{% endif %}">
              ${{ "%.2f"|format(holding.unrealized_pl or 0) }}
            </td>
            <td>
              <form action="{{ url_for('sell_stock', user_id=user_id) }}" method="post" style="display:inline;">
                <input type="hidden" name="stock_id" value="{{ holding.stock_id }}">
                <input type="number" name="quantity" placeholder="Qty" min="1" max="{{ holding.quantity }}" required style="width:60px;">
                <button type="submit">Sell</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No holdings yet. Buy some stocks to get started!</p>
    {% endif %}
  </section>

  <!-- Transaction History -->
  <section class="panel">
    <h2>Transaction History</h2>
    {% if transaction_history %}
      <table>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Symbol</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Total Value</th>
          <th>Cash After</th>
        </tr>
        {% for transaction in transaction_history %}
          <tr>
            <td>{{ transaction.timestamp }}</td>
            <td class="{% if transaction.order_type == 'BUY' %}buy{% else %}sell{% endif %}">
              {{ transaction.order_type }}
            </td>
            <td>{{ transaction.symbol }}</td>
            <td>{{ transaction.quantity }}</td>
            <td>${{ "%.2f"|format(transaction.price) }}</td>
            <td>${{ "%.2f"|format(transaction.quantity * transaction.price) }}</td>
            <td>${{ "%.2f"|format(transaction.cash_after) }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No transactions yet. Start trading to see your history!</p>
    {% endif %}
  </section>

</main>

<footer>
  <p>&copy; 2025 EquiSense</p>
</footer>

<script>
async function refreshMarketStatus() {
  try {
    const res = await fetch("/api/market/status");
    if (!res.ok) return;
	console.log("test:");
    const status = await res.json();
    // Banner elements
    const banner = document.getElementById("market-status-banner");
    const statusText = document.getElementById("market-status-text");
    const reasonEl = document.getElementById("market-reason");
    const nextOpenEl = document.getElementById("market-nextopen");

    if (!banner || !statusText || !reasonEl || !nextOpenEl) return;

    // All buy/sell forms
    const buySellForms = document.querySelectorAll(
      'form[action*="/buy_stock"], form[action*="/sell_stock"]'
    );

    if (status.status === "open") {
      // Market is open
      banner.style.display = "none";

      // Enable all inputs/buttons in buy/sell forms
      buySellForms.forEach(form => {
        form.querySelectorAll("input, button").forEach(el => {
          el.disabled = false;
          el.classList.remove("disabled-btn");
        });
      });

    } else {
      // Market is closed
      banner.style.display = "block";
      banner.style.background = "#ffebee"; // light red
      statusText.textContent = "Market Closed";
      reasonEl.textContent = status.reason || "Market is currently closed.";
      nextOpenEl.textContent = status.next_open ? `Next open: ${status.next_open}` : "";

      // Disable all inputs/buttons and apply CSS class
      buySellForms.forEach(form => {
        form.querySelectorAll("input, button").forEach(el => {
          el.disabled = true;
          el.classList.add("disabled-btn");
        });
      });
    }

  } catch (err) {
    console.warn("Could not refresh market status:", err);
  }
}

// Initial refresh and repeat every 30 seconds
document.addEventListener("DOMContentLoaded", () => {
  refreshMarketStatus();
  setInterval(refreshMarketStatus, 30000);
});
</script>



</body>
</html>
