<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EquiSense - Trading Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .price-up { color: green; }
    .price-down { color: red; }
    .positive { color: green; }
    .negative { color: red; }
    .disabled-btn { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
<header>
  <h1>EquiSense</h1>
  <nav>
    <ul>
      <li><a href="{{ url_for('dashboard', user_id=user_id) }}">Trading Dashboard</a></li>
      {% if session.is_admin == 1 %}
      <li><a href="{{ url_for('admin') }}">Admin Panel</a></li>
      {% endif %}
    </ul>
  </nav>
  <div class="user-info">
    <p>Logged in as: <strong>{{ user['username'] }}</strong></p>
    <form action="{{ url_for('logout') }}" method="post">
      <button type="submit">Log Out</button>
    </form>
  </div>
</header>

<main>

  <!-- Market status banner -->
  <div id="market-status-banner" style="display:none; padding:12px; margin:12px; border-radius:8px; background:#ffeeee;">
    <strong id="market-status-text"></strong>
    <div id="market-reason" style="margin-top:6px;"></div>
    <div id="market-nextopen" style="margin-top:6px; font-style:italic;"></div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Account Summary -->
  <section class="panel">
    <h2>Account Summary</h2>
    <div class="account-summary">
      <div class="balance-item">
        <h3>Cash Balance</h3>
        <p id="cash-balance">${{ "%.2f"|format(balance) }}</p>
      </div>
      <div class="balance-item">
        <h3>Portfolio Value</h3>
        <p id="portfolio-value">${{ "%.2f"|format(portfolio|sum(attribute='value') or 0) }}</p>
      </div>
      <div class="balance-item">
        <h3>Total Account Value</h3>
        <p id="total-value">${{ "%.2f"|format(balance + (portfolio|sum(attribute='value') or 0)) }}</p>
      </div>
      <div class="balance-item">
        <h3>Overall Profit</h3>
        <p id="overall-profit">${{ "%.2f"|format(overall_profit) }}</p>
      </div>
      <div class="balance-item">
        <h3>Profit %</h3>
        <p id="profit-pct">{{ "%.2f"|format(profit_pct) }}%</p>
      </div>
    </div>
  </section>

  <!-- Deposit/Withdraw -->
  <section class="panel">
    <div class="form-section">
      <div class="depositwithdraw">
        <h3>Deposit / Withdraw</h3>
        <form action="{{ url_for('depositwithdraw', user_id=user_id) }}" method="post">
          <label for="account-amount">Amount</label>
          <input type="number" id="account-amount" name="amount" step="0.01" min="0.01" required>
          <div class="button-row">
            <button type="submit" name="action" value="deposit">Deposit</button>
            <button type="submit" name="action" value="withdraw">Withdraw</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- Available Stocks -->
  <section class="panel">
    <h2>Available Stocks</h2>
    {% if available_stocks %}
    <table id="available-stocks-table">
      <tr>
        <th>Symbol</th>
        <th>Company</th>
        <th>Current Price</th>
        <th>Last Change</th>
        <th>Action</th>
      </tr>
      {% for stock in available_stocks %}
      <tr class="stock-row" data-stock="{{ stock.stock_id }}">
        <td>{{ stock.symbol }}</td>
        <td>{{ stock.company_name }}</td>
        <td class="current-price">${{ "%.2f"|format(stock.price) }}</td>
        <td class="last-change {{ 'price-up' if stock.last_change >=0 else 'price-down' }}">
          ${{ "%.2f"|format(stock.last_change or 0) }}
        </td>
        <td>
          <form action="{{ url_for('buy_stock', user_id=user_id) }}" method="post" style="display:inline;">
            <input type="hidden" name="stock_id" value="{{ stock.stock_id }}">
            <input type="number" name="quantity" placeholder="Qty" min="1" required style="width:60px;">
            <button type="submit">Buy</button>
          </form>
          <button class="view-stock-btn" data-stock="{{ stock.stock_id }}">View Chart</button>
        </td>
      </tr>
      {% endfor %}
    </table>
    {% else %}
      <p>No stocks available. Admin needs to add stocks to the system.</p>
    {% endif %}
  </section>

  <!-- My Holdings -->
  <section class="panel">
    <h2>My Holdings</h2>
    {% if portfolio %}
    <table id="portfolio-table">
      <tr>
        <th>Symbol</th>
        <th>Company</th>
        <th>Shares</th>
        <th>Avg Cost</th>
        <th>Current Price</th>
        <th>Market Value</th>
        <th>P/L</th>
        <th>Last Change</th>
        <th>Action</th>
      </tr>
      {% for holding in portfolio %}
      <tr class="stock-row" 
          data-stock="{{ holding.stock_id }}" 
          data-quantity="{{ holding.quantity }}" 
          data-avg-cost="{{ holding.avg_cost }}">
        <td>{{ holding.symbol }}</td>
        <td>{{ holding.company_name }}</td>
        <td>{{ holding.quantity }}</td>
        <td>${{ "%.2f"|format(holding.avg_cost or 0) }}</td>
        <td class="current-price">${{ "%.2f"|format(holding.current_price) }}</td>
        <td class="market-value">${{ "%.2f"|format(holding.value) }}</td>
        <td class="pl {{ 'positive' if holding.unrealized_pl >=0 else 'negative' }}">
          ${{ "%.2f"|format(holding.unrealized_pl or 0) }}
        </td>
        <td class="last-change {{ 'price-up' if holding.last_change >=0 else 'price-down' }}">
          ${{ "%.2f"|format(holding.last_change or 0) }}
        </td>
        <td>
          <form action="{{ url_for('sell_stock', user_id=user_id) }}" method="post" style="display:inline;">
            <input type="hidden" name="stock_id" value="{{ holding.stock_id }}">
            <input type="number" name="quantity" placeholder="Qty" min="1" max="{{ holding.quantity }}" required style="width:60px;">
            <button type="submit">Sell</button>
          </form>
          <button class="view-stock-btn" data-stock="{{ holding.stock_id }}">View Chart</button>
        </td>
      </tr>
      {% endfor %}
    </table>
    {% else %}
      <p>No holdings yet. Buy some stocks to get started!</p>
    {% endif %}
  </section>

  <!-- Performance / Chart -->
  <section class="panel">
    <h2>Stock Price History</h2>
    <canvas id="portfolioChart" width="600" height="300"></canvas>
  </section>

</main>

<footer>
  <p>&copy; 2025 EquiSense</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ---------- CHART ----------
let currentStock = null;
let chart = null;

async function fetchChartData(stock_id) {
  const res = await fetch(`/api/price_history/${stock_id}`);
  if (!res.ok) return { timestamps: [], prices: [] };
  return await res.json();
}

async function updateChart(stock_id) {
  const data = await fetchChartData(stock_id);
  const labels = data.timestamps;
  const prices = data.prices;

  if (!chart) {
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Price ($)',
          data: prices,
          borderWidth: 2,
          tension: 0.25
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: "Time" } },
          y: { title: { display: true, text: "Price ($)" } }
        }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = prices;
    chart.update();
  }
}

// Stock chart buttons
document.querySelectorAll('.view-stock-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const stockId = btn.dataset.stock;
    currentStock = stockId;
    updateChart(stockId);
  });
});

// ---------- DASHBOARD AUTO-UPDATE ----------
async function updateAllStocks() {
  try {
    const res = await fetch('/api/prices');
    if (!res.ok) return;
    const stocks = await res.json();

    stocks.forEach(stock => {
      // Update Available Stocks
      const availRow = document.querySelector(`#available-stocks-table .stock-row[data-stock='${stock.stock_id}']`);
      if (availRow) {
        availRow.querySelector('.current-price').textContent = `$${stock.price.toFixed(2)}`;
        const lastEl = availRow.querySelector('.last-change');
        lastEl.textContent = `$${(stock.last_change ?? 0).toFixed(2)}`;
        lastEl.className = (stock.last_change ?? 0) >= 0 ? 'price-up last-change' : 'price-down last-change';
      }

      // Update Portfolio
      const portRow = document.querySelector(`#portfolio-table .stock-row[data-stock='${stock.stock_id}']`);
      if (portRow) {
        const qty = parseFloat(portRow.dataset.quantity || 0);
        const avg = parseFloat(portRow.dataset.avgCost || 0);

        portRow.querySelector('.current-price').textContent = `$${stock.price.toFixed(2)}`;
        portRow.querySelector('.market-value').textContent = `$${(qty * stock.price).toFixed(2)}`;
        portRow.querySelector('.pl').textContent = `$${((stock.price - avg) * qty).toFixed(2)}`;
        const lastEl = portRow.querySelector('.last-change');
        lastEl.textContent = `$${(stock.last_change ?? 0).toFixed(2)}`;
        lastEl.className = (stock.last_change ?? 0) >= 0 ? 'price-up last-change' : 'price-down last-change';
      }
    });
  } catch (err) {
    console.warn("Error updating stock tables:", err);
  }
}

// ---------- MARKET STATUS ----------
async function refreshMarketStatus() {
  try {
    const res = await fetch("/api/market/status");
    if (!res.ok) return;
    const status = await res.json();
    const banner = document.getElementById("market-status-banner");
    const statusText = document.getElementById("market-status-text");
    const reasonEl = document.getElementById("market-reason");
    const nextOpenEl = document.getElementById("market-nextopen");

    if (status.status === "open") {
      banner.style.display = "none";
      document.querySelectorAll('form[action*="/buy_stock"], form[action*="/sell_stock"]').forEach(f => {
        f.querySelectorAll("input, button").forEach(el => { el.disabled = false; el.classList.remove("disabled-btn"); });
      });
    } else {
      banner.style.display = "block";
      banner.style.background = "#ffebee";
      statusText.textContent = "Market Closed";
      reasonEl.textContent = status.reason || "Market is currently closed.";
      nextOpenEl.textContent = status.next_open ? `Next open: ${status.next_open}` : "";
      document.querySelectorAll('form[action*="/buy_stock"], form[action*="/sell_stock"]').forEach(f => {
        f.querySelectorAll("input, button").forEach(el => { el.disabled = true; el.classList.add("disabled-btn"); });
      });
    }
  } catch (err) {
    console.warn("Could not refresh market status:", err);
  }
}

// ---------- INITIALIZE ----------
document.addEventListener("DOMContentLoaded", () => {
  refreshMarketStatus();
  updateAllStocks();
  if (currentStock) updateChart(currentStock);

  setInterval(() => {
    updateAllStocks();
    if (currentStock) updateChart(currentStock);
  }, 5000);

  setInterval(refreshMarketStatus, 30000);
});
</script>
</body>
</html>
